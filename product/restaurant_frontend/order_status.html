<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Order Status</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            padding: 40px;
        }
        .card {
            background: #fff;
            padding: 20px;
            max-width: 500px;
            margin: auto;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .processing { color: orange; }
        .success { color: green; }
        .failed { color: red; }
        button {
            padding: 10px 16px;
            cursor: pointer;
        }
    </style>
</head>
<body>

<div class="card">
    <h2>ğŸ§¾ Order Status</h2>

    <p><b>Order ID:</b> <span id="orderIdText"></span></p>
    <p id="statusText">Checking status...</p>

    <button onclick="checkStatus()">ğŸ”„ Refresh</button>
</div>

<script src="/static/js/api.js"></script>
<script>
    // âœ… URL se UUID uthao
    // example: /orders/status.html?order_id=552d4e1e-...
    const params = new URLSearchParams(window.location.search);
    const orderId = params.get("order_id");

    document.getElementById("orderIdText").innerText = orderId;

    let pollingInterval = null;

    async function checkStatus() {
        const statusEl = document.getElementById("statusText");
        statusEl.innerText = "Checking status...";

        try {
            const response = await apiFetch(
                `/api/orders/status/${orderId}/`,
                { method: "GET" }
            );

            const data = await response.json();
            handleResponse(response.status, data);

        } catch (err) {
            statusEl.className = "failed";
            statusEl.innerText = "âŒ Network error. Try again.";
        }
    }

    function handleResponse(statusCode, data) {
        const statusEl = document.getElementById("statusText");

        // â³ Stripe webhook delay case
        if (statusCode === 202 && data.status === "processing") {
            statusEl.className = "processing";
            statusEl.innerText = "â³ Payment is processing...";

            if (!pollingInterval) {
                pollingInterval = setInterval(checkStatus, 5000);
            }
            return;
        }

        // ğŸ›‘ stop polling once final
        if (pollingInterval) {
            clearInterval(pollingInterval);
            pollingInterval = null;
        }

        if (data.status === "failed") {
            statusEl.className = "failed";
            statusEl.innerText = "âŒ Payment Failed. Refund if deducted.";
            return;
        }

        if (data.status === "success") {
            statusEl.className = "success";
            statusEl.innerHTML = `
                âœ… <b>Order Confirmed</b><br>
                ğŸ’³ Payment ID: ${data.payment_id}<br>
                ğŸ’° Amount: â‚¹${data.amount}<br>
                ğŸ§¾ Invoice: ${data.invoice_available ? "Available" : "Generating..."}
            `;
        }
    }

    // ğŸš€ auto start
    if (orderId) {
        checkStatus();
    } else {
        document.getElementById("statusText").innerText =
            "âŒ Invalid order link";
    }
</script>

</body>
</html>
